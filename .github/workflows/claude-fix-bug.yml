# Nexus - Claude Code Bug Fix Workflow
# This workflow is triggered by repository_dispatch events from the Nexus platform
# when a "Fix with Claude" button is clicked on a bug report.

name: Claude Fix Bug

on:
  repository_dispatch:
    types: [claude-fix-bug]

# Top-level permissions for the entire workflow
permissions:
  contents: write
  pull-requests: write
  id-token: write
  actions: write

jobs:
  fix-bug:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.client_payload.branch || 'main' }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm install --legacy-peer-deps
        env:
          DATABASE_URL: "postgresql://dummy:dummy@localhost:5432/dummy"

      - name: Configure Git
        run: |
          git config --global user.name "Claude AI"
          git config --global user.email "claude@anthropic.com"

      - name: Run Claude Code Action
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          show_full_output: true
          prompt: |
            ${{ github.event.client_payload.prompt }}

            IMPORTANT: After making the changes:
            1. Use git add to stage the changed files
            2. Use git commit with a descriptive message
            3. Use git push to push the changes to origin/main
          settings: |
            {
              "permissions": {
                "allow": ["Bash", "Read", "Write", "Edit", "Glob", "Grep", "TodoWrite"]
              }
            }

      - name: Push changes if any
        if: success()
        env:
          PROMPT_TEXT: ${{ github.event.client_payload.prompt }}
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "Uncommitted changes found, committing..."
            git add -A
            # Use env variable for safe commit message
            git commit -m "ðŸ¤– AI Fix: ${PROMPT_TEXT}" || true
          fi
          git push origin HEAD:main || echo "Nothing to push or push failed"

      - name: Calculate duration
        id: metrics
        if: always()
        run: |
          # Calculate workflow duration
          START_TIME=${{ github.event.client_payload.startTime }}
          if [ -z "$START_TIME" ]; then
            START_TIME=$(date -u +%s)000
          fi
          END_TIME=$(date -u +%s)000
          DURATION=$((END_TIME - START_TIME))
          echo "duration=$DURATION" >> $GITHUB_OUTPUT

          # Try to extract cost from Claude output (if available in logs)
          # For now, we'll leave it empty and let the action populate it if it provides it
          echo "cost=" >> $GITHUB_OUTPUT

      - name: Report status to Nexus
        if: always()
        run: |
          COST_USD=""
          DURATION_MS="${{ steps.metrics.outputs.duration }}"

          # Try to get cost from Claude Code Action output if available
          if [ -n "${{ steps.claude.outputs.cost }}" ]; then
            COST_USD="${{ steps.claude.outputs.cost }}"
          fi

          # Build JSON payload
          PAYLOAD=$(cat <<EOF
          {
            "fixAttemptId": "${{ github.event.client_payload.fixAttemptId }}",
            "bugId": "${{ github.event.client_payload.bugId }}",
            "status": "${{ job.status }}",
            "branch": "${{ github.event.client_payload.branch }}",
            "workflowUrl": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"$([ -n "$COST_USD" ] && echo ",\"costUsd\": $COST_USD")$([ -n "$DURATION_MS" ] && echo ",\"durationMs\": $DURATION_MS")
          }
          EOF
          )

          curl -X POST "${{ secrets.NEXUS_WEBHOOK_URL }}/api/github/callback" \
            -H "Authorization: Bearer ${{ secrets.NEXUS_WEBHOOK_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD"
